# For more Go information and examples, see
# https://docs.semaphoreci.com/article/86-language-golang
version: v1.0
name: Upgrade Manager
agent:
  machine:
    type: e1-standard-2
    # os_image: ubuntu1804
  containers:
    - name: main
      image: semaphoreci/golang:1.12.9
blocks:
  - name: Setup
    task:
      prologue:
        commands:
          # - wget https://dl.google.com/go/go1.12.7.linux-amd64.tar.gz
          # - sudo tar -xvf go1.12.7.linux-amd64.tar.gz
          # - sudo cp go/bin/go /usr/local/bin
          # - sudo rm -rf /usr/local/go
          # - sudo mv go /usr/local
          # # - go version
          # # - which go
          # # - mkdir -p ~/go/bin
          # - export os=$(go env GOOS)
          # - export arch=$(go env GOARCH)
          # # download the release
          # - curl -sL https://go.kubebuilder.io/dl/latest/${os}/${arch} | tar -xz -C /tmp/
          # - sudo mv /tmp/kubebuilder_master_${os}_${arch} /usr/local/kubebuilder
          # - export PATH=$PATH:/usr/local/kubebuilder/bin
          - checkout
          - source .semaphore/setup.sh
          - ls -l /packages

      jobs:
        - name: Env Setup
          commands:
            - cache restore $SEMAPHORE_PROJECT_NAME-deps
            # - sudo tar -xvf /packages/go1.12.7.linux-amd64.tar.gz -C /packages
            - sudo cp /packages/go/bin/go /usr/local/bin
            - sudo rm -rf /usr/local/go
            - sudo mv /packages/go /usr/local
            - export os=$(go env GOOS)
            - export arch=$(go env GOARCH)
            # - tar -xz /packages/kubebuilder_master_${os}_${arch}.tar.gz -C /packages
            - sudo mv /packages/kubebuilder_master_${os}_${arch} /usr/local/kubebuilder
            - ls /usr/local/kubebuilder
            - export PATH=$PATH:/usr/local/kubebuilder/bin

  - name: Build
    task:
      jobs:
        - name: Docker Build
          commands:
            # - go version
            # - which go
            - ls /usr/local/kubebuilder
            - export PATH=$PATH:/usr/local/kubebuilder/bin
            # - mkdir -p ~/go/bin
            # - mkdir ~/go/src
            # - export GOPATH=~/go
            # - cat Makefile
            - checkout
            - make docker-build
